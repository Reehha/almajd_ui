<div class="dashboard-container">
    <div class="dashboard-header">
      <button class="scan-btn" (click)="scanQR()">
        <i class="fas fa-qrcode"></i> <span class="btn-text">Scan QR</span>
      </button>
    </div>
  
    <div class="dashboard-overview">
      <!-- Chart on the left -->
      <div class="overview-chart">
        <ng-container *ngIf="paginatedData.length > 0 && totalEmployees > 0; else noData">
          <app-attendance-chart
            [attendanceData]="filteredData"   
            [totalEmployees]="totalEmployees"
          ></app-attendance-chart>
        </ng-container>
      
        <ng-template #noData>
          <div class="no-chart-data">No records to display chart</div>
        </ng-template>
      </div>
      
    
       <!-- Summary blocks on the right -->
    
       <div class="box-container">

        <!-- Present Box -->
        <div class="summary-box present"
             (click)="toggleExpand('present')"
             [class.expanded]="expandedBox === 'present'">
             
          <div class="box-header">
            {{ totalPresent }} <br>
            <div>Present</div>
            <span class="chevron" [class.rotate]="expandedBox === 'present'">▼</span>
          </div>
      
          <div class="sub-boxes">
            <div class="sub-box ontime">
              {{ initialCounts.onTime }} <br> On Time
            </div>
            <div class="sub-box overtime">
              {{ initialCounts.overTime }} <br> Overtime
            </div>
            <div class="sub-box shorttime">
              {{ initialCounts.shortTime }} <br> Short Time
            </div>
          </div>
        </div>
      
        <!-- Absent Box -->
        <div class="summary-box absent"
             (click)="toggleExpand('absent')"
             [class.expanded]="expandedBox === 'absent'">
      
          <div class="box-header">
            {{ initialCounts.absent }} <br>
            <div>Absent</div>
            <span class="chevron" [class.rotate]="expandedBox === 'absent'">▼</span>
          </div>
      
          <div class="sub-boxes">
            <div class="sub-box leave">
              0<br> On Leave
            </div>
            <div class="sub-box uninformed">
              {{ initialCounts.absent }} <br> Uninformed
            </div>
          </div>
        </div>
      
      </div>      
    
<!-- FILTER PANEL -->
<div class="filter-panel">
  <div class="filter-group">
    <div class="filter-item">
      <!-- <label for="employeeName">Employee Name</label> -->
      <input id="employeeName" type="text" [(ngModel)]="employeeName" (input)="applyFilters()" placeholder="Search by name">
    </div>

    <div class="filter-item">
      <select id="department" [(ngModel)]="department" (change)="applyFilters()">
        <option value="">All Departments</option>
        <option *ngFor="let dept of departments" [value]="dept">{{ dept }}</option>
      </select>
    </div>

    <div class="filter-item">
      <select id="organization" [(ngModel)]="organization" (change)="applyFilters()">
        <option value="">All Organizations</option>
        <option *ngFor="let org of organizations" [value]="org">{{ org }}</option>
      </select>
    </div>

    <div class="filter-item">
      <select id="location" [(ngModel)]="locationName" (change)="applyFilters()">
        <option value="">All Locations</option>
        <option *ngFor="let loc of locations" [value]="loc">{{ loc }}</option>
      </select>
    </div>

    <div class="filter-item">
      <label>Start Date</label>
      <input type="date" lang="en-CA" [(ngModel)]="startDate">
    </div>

    <div class="filter-item">
      <label>End Date</label>
      <input type="date" lang="en-CA" [(ngModel)]="endDate">
    </div>
  </div>
  </div>

  <div class="tab-bar attendance-tab">
    <button [class.active]="activeTab==='all'" (click)="switchTab('all')">All</button>
    <button [class.active]="activeTab==='present'" (click)="switchTab('present')">Present</button>
    <button [class.active]="activeTab==='absent'" (click)="switchTab('absent')">Absent</button>
  </div>

      <div class="filter-apply">
        <button (click)="onDateFilter()" class="btn">Apply</button>
        <button (click)="exportToExcel()" class="btn export-btn">Export Excel</button>
      </div>
      <div class="table-scroll">
        <table class="attendance-table">
          <thead>
            <tr>
              <th>Date</th>
              <!-- <th>EMPLOYEE ID</th> -->
              <th>EMPLOYEE Name</th>
              <th>Punch In</th>
              <th>Punch Out</th>
              <th>Work hours</th>
              <th>Status</th>
              <th *ngIf="activeTab !== 'absent'">Site Location</th>
              <th *ngIf="activeTab !== 'absent'">Info</th>


            </tr>
          </thead>
          <tbody>
            <tr *ngIf="paginatedData.length === 0">
              <td colspan="8" class="no-records">No records found</td>
            </tr>
          
            <ng-container *ngFor="let entry of paginatedData; let i = index">
              <!-- Main row -->
              <tr>
                <td data-label="Date">{{formatDate(entry.date)}}</td>
                <td data-label="Name">{{entry.firstName}}, {{entry.lastName.charAt(0)}}</td>
          
                <td data-label="Punch In">
                  <ng-container *ngIf="entry.punchInUpdated != entry.punchIn; else normalIn">
                    {{ entry.punchInUpdated }}
                    <span class="up-arrow">↑</span> [ {{ entry.updatedDeduction }} ]
                  </ng-container>
                  <ng-template #normalIn>
                    {{ entry.punchIn || '-' }}
                  </ng-template>
                </td>
          
                <td data-label="Punch Out">
                  <ng-container *ngIf="entry.punchOutUpdated != entry.punchOut; else normalOut">
                    {{ entry.punchOutUpdated }}
                    <span class="down-arrow">↓</span> [ {{ entry.updatedDeduction }} ]
                  </ng-container>
                  <ng-template #normalOut>
                    {{ entry.punchOut || '-' }}
                  </ng-template>
                </td>
          
                <td data-label="Work Hours">{{ entry.workHours || '-' }}</td>
          
                <td data-label="Status">
                  <span class="status-tag" [ngClass]="getStatusClass(entry.status)">
                    {{ entry.status }}
                    <br *ngIf="entry.statusValue" />
                    <span *ngIf="entry.statusValue && (entry.status === 'Short Time' || entry.status === 'Overtime')" class="status-time">
                      {{ entry.statusValue }}
                    </span>
                  </span>
                </td>
                
          
                <td *ngIf="activeTab !== 'absent'" data-label="Site Location">
                  {{ entry.locationName }}
                  <button class="icon-btn" (click)="openLocationDialog(entry)" [disabled]="entry.status?.toLowerCase() === 'absent'"
                    [ngStyle]="{
                      cursor: entry.status?.toLowerCase() === 'absent' ? 'not-allowed' : 'pointer',
                      opacity: entry.status?.toLowerCase() === 'absent' ? 0.5 : 1
                    }">
                    <ng-container *ngIf="entry.designation?.toLowerCase() === 'driver'; else editBtn">
                      <i class="fas fa-truck delivery-icon"></i>
                    </ng-container>
                    <ng-template #editBtn>
                      <i class="fas fa-edit edit-icon"></i>
                    </ng-template>
                  </button>
                </td>
                
                <td *ngIf="activeTab !== 'absent'" data-label="Actions" class="actions-cell">
                  <div
                    class="action-menu"
                    [class.disabled]="entry.status?.toLowerCase() === 'absent'"
                  >
                    <button
                      class="icon-btn menu-btn"
                      [disabled]="entry.status?.toLowerCase() === 'absent'"
                      [ngStyle]="{
                        cursor: entry.status?.toLowerCase() === 'absent' ? 'not-allowed' : 'pointer',
                        opacity: entry.status?.toLowerCase() === 'absent' ? 0.5 : 1
                      }"
                    >
                      <i class="fas fa-ellipsis-v"></i>
                    </button>
                
                    <div class="dropdown-menu">
                      <button (click)="openScheduleDialog(entry)">Change Schedule</button>
                      <!-- add more options here -->
                    </div>
                  </div>
                  <button
                  class="icon-btn expand-btn"
                  (click)="toggleBreaks(entry)"
                  [attr.aria-expanded]="expandedEntryKey === entry ? 'true' : 'false'"
                  [disabled]="entry.status?.toLowerCase() === 'absent'"
                  [ngStyle]="{
                    cursor: entry.status?.toLowerCase() === 'absent' ? 'not-allowed' : 'pointer',
                    opacity: entry.status?.toLowerCase() === 'absent' ? 0.5 : 1
                  }"
                >
                  <i class="fas fa-chevron-down"></i>
                </button>
                
                </td>
                            
              </tr>
          
              <!-- Expanded row (new row) -->
              <tr *ngIf="expandedEntryKey === entry" class="expanded-row">
                <td colspan="8">
                  <div class="breaks-container">
                    <ng-container *ngIf="entry.punches && getBreakKeys(entry.punches).length > 0; else noBreaks">
                      <ul>
                        <li><strong>PUNCH DETAILS</strong></li>
                        <ul>
                          <li *ngFor="let key of getBreakKeys(entry.punches)">
                            {{ entry.punches[key].startTime }} → {{ entry.punches[key].endTime }}
                           </li>
                        </ul>
                      </ul>
                    </ng-container>
                    <ng-template #noBreaks>
                      <p class="no-records">No extra punches recorded</p>
                    </ng-template>
                  </div>
                </td>
              </tr>
          
            </ng-container>
          </tbody>
          
        </table>
<!-- Location Modal -->
<div class="location-modal-backdrop" *ngIf="showLocationDialog">
  <div class="location-modal">

    <div class="location-modal-info">
      <p><strong>Employee Name  : </strong> {{ selectedEmployee?.firstName }} {{ selectedEmployee?.lastName }}</p>
      <p><strong>Punch In  : </strong> {{ selectedEmployee?.punchInUpdated || selectedEmployee?.punchIn || '-' }}</p>
      <p><strong>Punch Out : </strong> {{ selectedEmployee?.punchOutUpdated || selectedEmployee?.punchOut || '-' }}</p>

    </div>

    <div class="filter-item">
      <label>Location</label>
      <select [(ngModel)]="selectedLocation" (change)="onLocationChange($event)">
        <option *ngFor="let loc of filteredLocations" [value]="loc.locationName">{{ loc.locationName }}</option>
      </select>
    </div>

    <div class="filter-item">
      <label>Travel Time</label>
      <input [value]="travelTime" disabled />
    </div>

    <div class="location-modal-actions">
      <button class="btn main" (click)="submitLocation()">Save</button>
      <button class="btn cancel" (click)="closeDialog()">Cancel</button>
    </div>

    <div class="location-message success-msg" *ngIf="successMessage">{{ successMessage }}</div>
    <div class="location-message error-msg" *ngIf="errorMessage">{{ errorMessage }}</div>
  </div>
</div>

<!-- Schedule Change Modal -->
<div class="location-modal-backdrop" *ngIf="showScheduleDialog">
  <div class="location-modal">
    <div class="location-modal-info">
      <p><strong>Employee Name:</strong> {{ selectedEmployee?.firstName }} {{ selectedEmployee?.lastName }}</p>
      <p><strong>Current Schedule:</strong> {{ selectedEmployee?.scheduleDisplayTime || '-' }}</p>
    </div>

    <div class="filter-item">
      <label>Choose New Schedule</label>
      <select [(ngModel)]="selectedScheduleId">
        <option value="" disabled>Select Schedule</option>
        <option *ngFor="let sch of schedules" [value]="sch.scheduleId">{{ sch.displayTime }}</option>
      </select>
    </div>

    <div class="location-modal-actions">
      <button class="btn main" (click)="submitSchedule()">Save</button>
      <button class="btn cancel" (click)="closeDialog()">Cancel</button>
    </div>

    <div class="location-message success-msg" *ngIf="successMessage">{{ successMessage }}</div>
    <div class="location-message error-msg" *ngIf="errorMessage">{{ errorMessage }}</div>
  </div>
</div>


        <div class="pagination">
          <button (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">Prev</button>
        
          <ng-container *ngFor="let item of paginationRange">
            <button 
              *ngIf="isNumber(item)"
              (click)="goToPage(item)"
              [class.active]="item === currentPage">
              {{ item }}
            </button>
        
            <span *ngIf="!isNumber(item)">...</span>
          </ng-container>
        
          <button (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">Next</button>
        </div>
        
        
      </div>
  </div>
</div>

