<div class="dashboard-container">

  <!-- Chart + Schedule -->
  <div class="dashboard-overview">

    <!-- <div class="overview-summary"> -->
      <div class="summary-box total">
        <div class="user-info">
          <div class="user-avatar">
            <i class="fas fa-user-circle"></i>
          </div>
          <div class="user-details">
            <h3>{{ userInfo.firstName }} {{ userInfo.lastName }}'s Schedule</h3>
          </div>
        </div>
      
        <div class="schedule-info">
          <div class="schedule-item">
            <span class="label"><i class="fas fa-clock"></i> Time:</span>
            <span class="value">{{ todaySchedule.time }}</span>
          </div>
          <div class="schedule-item">
            <span class="label"><i class="fas fa-map-marker-alt"></i> Location:</span>
            <span class="value">{{ todaySchedule.location }}</span>
          </div>
        </div>
      </div>
    <div class="overview-chart">
      <!-- <h3>Attendance Chart</h3> -->
        <div *ngIf="!noData; else noDataTemplate " >
          <canvas id="attendanceChart"></canvas>
        </div>
      
        <ng-template #noDataTemplate>
          <div class="no-chart-data">No records to display chart</div>
        </ng-template>
      
       <!-- Filter Panel -->
    <div class="filter-group">
      <div class="filter-item">
        <label for="startDate">Start date:</label>
        <input type="date" lang="en-CA" id="startDate" name="startDate" [(ngModel)]="startDate" #startRef="ngModel"/>
      </div>
      <div class="filter-item">
        <label for="endDate">End date:</label>
        <input type="date" lang="en-CA" id="endDate" name="endDate" [(ngModel)]="endDate"  #endRef="ngModel" />
      </div>
      <div *ngIf="(startRef.touched || endRef.touched) && dateError" class="error-message">
        {{ dateError }}
      </div>      
      <div class="filter-item align-end">
        <button (click)="fetchData()" class="btn">Apply</button>
        <button (click)="exportToExcel()" class="export-btn">Export Excel</button>
      </div>
    </div>
    </div>
      
    <!-- </div> -->
  </div>

  <!-- Attendance Table -->
  <div class="table-container">
    <div class="table-scroll">
      <table class="attendance-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Punch In</th>
            <th>Punch Out</th>
            <th>Work Hours</th>
            <th>Status</th>
            <th>Site Location</th>
            <th>Info</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="filteredData.length === 0">
            <td colspan="6" class="no-records">No records found</td>
          </tr>
        
          <ng-container *ngFor="let row of filteredData; let i = index">
            <!-- Main row -->
            <tr>
              <td data-label="Date">{{ formatDate(row.date) }}</td>
        
              <td data-label="Punch In">
                <ng-container *ngIf="row.punchInUpdated != row.punchIn; else normalIn">
                  {{ row.punchInUpdated }} <span class="up-arrow">↑</span> [ {{ row.updatedDeduction || '-' }} ]
                </ng-container>
                <ng-template #normalIn>{{ row.punchIn || '-' }}</ng-template>
              </td>
        
              <td data-label="Punch Out">
                <ng-container *ngIf="row.punchOutUpdated != row.punchOut; else normalOut">
                  {{ row.punchOutUpdated }} <span class="down-arrow">↓</span> [ {{ row.updatedDeduction || '-' }} ]
                </ng-container>
                <ng-template #normalOut>{{ row.punchOut || '-' }}</ng-template>
              </td>
              <td data-label="Work Hours">{{ row.workHours }}</td>
        
              <td data-label="Status">
                <span class="status-tag" [ngClass]="getStatusClass(row.status)">
                  {{ row.status }}<br>
                  <span *ngIf="row.statusValue" class="status-value">
                    {{ row.statusValue }}
                  </span>
                </span>
              </td>                   
        
              <td data-label="Site Location">
                {{ row.locationName || '-' }}
              </td>
        
              <!-- Expand button -->
              <td data-label="more-info">
                <button
                  class="icon-btn expand-btn"
                  (click)="toggleExpand(i)"
                  [attr.aria-expanded]="expandedRow === i"
                  title="View punch details">
                  <i class="fas" [ngClass]="expandedRow === i ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                </button>
              </td>
            </tr>
        
            <!-- Expanded row (new row with breaks) -->
            <tr *ngIf="expandedRow === i" class="expanded-row">
              <td colspan="6">
                <div class="expanded-content">
                  <ng-container *ngIf="row.breaks && getBreakKeys(row.breaks).length > 0; else noBreaks">
                    <ul>
                      <li><strong>PUNCH DETAILS</strong></li>
                      <ul>
                        <li *ngFor="let key of getBreakKeys(row.breaks)">
                          {{ row.breaks[key].startTime }} → {{ row.breaks[key].endTime }}
                        </li>
                      </ul>
                    </ul>
                  </ng-container>
                  <ng-template #noBreaks>
                    <p class="no-records">No extra punches recorded</p>
                  </ng-template>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
        
        <!-- </ng-template> -->
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination">
      <button (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1">Prev</button>
    
      <ng-container *ngFor="let page of paginationRange">
        <button
          *ngIf="isNumber(page)"
          (click)="onPageChange(page)"
          [class.active]="currentPage === page"
        >
          {{ page }}
        </button>
    
        <span *ngIf="!isNumber(page)" class="dots">...</span>
      </ng-container>
    
      <button
        (click)="onPageChange(currentPage + 1)"
        [disabled]="currentPage === totalPages"
      >
        Next
      </button>
    </div>    
  </div>
</div>
